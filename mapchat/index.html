<!DOCTYPE html>
<html>
	<head>
		<title>Assignment 2 - Comp 20</title> 
		<link rel="stylesheet" type="text/css" href="style.css">
		<script src="http://maps.google.com/maps/api/js?sensor=true"></script>
		<script>
			var map; 
			var my_lat = 0;
			var my_lng = 0;
			var myLocation = new google.maps.LatLng(my_lat, my_lng); 
			var locationMarker; 
			var info; 
			var xhr; 
			var locationData; 

			function init() {
				map = new google.maps.Map(document.getElementById('map'), {
 					center: myLocation,
					zoom: 15 }); 
				getCurrentLocation(); 
				parseData(); 
			}

			function getCurrentLocation(){
				if (navigator.geolocation){
					navigator.geolocation.getCurrentPosition(function(position) {
 						my_lat = position.coords.latitude
 						my_lng = position.coords.longitude;
 						showMyPosition(); 
					}); 	
				}

				else {
					alert("Sorry, geolocation is not supported on your browser.");
				}
			}

			function showMyPosition() {
				myLocation = new google.maps.LatLng(my_lat, my_lng);
				map.panTo(myLocation); 
				var img = '8th notes.jpg';
				
				//Source: https://developers.google.com/maps/documentation/javascript/markers
				myMarker = new google.maps.Marker({
					position: myLocation,
					map: map,
					title: 'My Location',
					icon: img,
				});

				//Source: https://developers.google.com/maps/documentation/javascript/infowindows
				info = new google.maps.InfoWindow({
					content: 'LisaLytle'
				});

				myMarker.addListener('click', function(){
					info.open(map, myMarker); 
				});
			}

			function parseData () {
				xhr = new XMLHttpRequest(); 
				var url = 'https://secret-about-box.herokuapp.com/sendLocation'; 

				xhr.open("POST", url, true); 
				xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); 
				
				xhr.onreadystatechange = function() {
					if(xhr.readyState == 4 && xhr.status == 200) {
						data = xhr.responseText; 
						locationData = JSON.parse(data); 
						console.log(locationData); //REMOVE 
						showMap(locationData); 
					}
				}
				//Source: http://stackoverflow.com/questions/4276226/ajax-xmlhttprequest-post
				var params = "login=LisaLytle&lat=" + encodeURIComponent(my_lat) + "&lng=" + encodeURIComponent(my_lng) + "&message=" + encodeURIComponent('Hey! This is my msg.');
				
				xhr.send(params); 
			}

			function showMap(locationData){
				for (count = 0; count < locationData.length; count++){
					loc = new google.maps.LatLng(locationData[count]["lat"], locationData[count]["lng"]);
					theirMarker = new google.maps.Marker({
						position: loc,
						map: map,
					});

					login = locationData[count]["login"];

					contentString = '<p>' + 'Login:' + login + '</p>'; 
					theirInfo = new google.maps.InfoWindow({
						content: contentString
					});

					theirMarker.addListener('click', function(){
						theirInfo.open(map, theirMarker); 
					}); 
				}
			}
		</script> 
	</head>

	<body onload ="init()">
		<div id ="map"></div> 
	</body>
</html>